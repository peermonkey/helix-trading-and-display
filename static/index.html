<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helix Trading Terminal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #0d1117;
            color: #f0f6fc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #21262d;
            border-bottom: 1px solid #30363d;
            color: #f0f6fc;
            font-weight: bold;
            padding: 10px 15px;
        }
        .table {
            color: #f0f6fc;
            margin-bottom: 0;
        }
        .table thead th {
            background-color: #21262d;
            border-color: #30363d;
            color: #58a6ff;
            font-weight: 600;
        }
        .table td, .table th {
            border-color: #30363d;
            padding: 8px;
            color: #f0f6fc;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #1c2128;
        }
        .btn-control {
            background-color: #238636;
            color: #ffffff;
            border: none;
            margin: 5px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-control:hover {
            background-color: #2ea043;
            color: #ffffff;
            transform: translateY(-1px);
        }
        .price-box {
            background-color: #1c2128;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            border-left: 4px solid #30363d;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .price-label {
            font-size: 0.9rem;
            color: #8b949e;
            margin-bottom: 5px;
        }
        .price-value {
            font-size: 1.3rem;
            font-weight: bold;
        }
        .positive {
            color: #3fb950;
        }
        .negative {
            color: #f85149;
        }
        .neutral {
            color: #f0f6fc;
        }
        .badge-bull {
            background-color: #238636;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .badge-bear {
            background-color: #da3633;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .param-label {
            font-size: 0.9rem;
            color: #8b949e;
        }
        .param-value {
            font-weight: bold;
            color: #f0f6fc;
        }
        .terminal-output {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 5px;
            color: #f0f6fc;
            font-family: 'Courier New', Courier, monospace;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            width: 100%;
            font-size: 0.9rem;
        }
        .helix-gauge {
            height: 80px;
            position: relative;
            background: linear-gradient(90deg, #da3633 0%, #ffbd2e 50%, #238636 100%);
            border-radius: 5px;
            margin: 20px 0 30px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .helix-marker {
            position: absolute;
            top: 0;
            height: 100%;
            width: 4px;
            background-color: white;
            transform: translateX(-2px);
            box-shadow: 0 0 8px rgba(255,255,255,0.8);
        }
        .helix-value {
            position: absolute;
            bottom: -25px;
            transform: translateX(-50%);
            color: #f0f6fc;
            font-weight: bold;
            background-color: #21262d;
            padding: 2px 8px;
            border-radius: 10px;
            border: 1px solid #30363d;
        }
        .settings-form .form-control {
            background-color: #21262d;
            border-color: #30363d;
            color: #f0f6fc;
        }
        .settings-form label {
            color: #8b949e;
            font-weight: 500;
            margin-bottom: 3px;
        }
        .btn-outline-secondary {
            color: #58a6ff;
            border-color: #58a6ff;
        }
        .btn-outline-secondary:hover {
            background-color: #58a6ff;
            color: #0d1117;
        }
        h2 {
            color: #58a6ff;
            font-weight: 600;
        }
        hr {
            border-color: #30363d;
            opacity: 1;
            margin: 15px 0;
        }
        .action-btn {
            color: #58a6ff;
            cursor: pointer;
            margin-left: 5px;
        }
        .action-btn:hover {
            color: #1f6feb;
        }
        #pause-bot {
            background-color: #da3633;
        }
        #pause-bot:hover {
            background-color: #f85149;
        }
        #resume-bot {
            background-color: #238636;
        }
        #resume-bot:hover {
            background-color: #2ea043;
        }
        .highlight-box {
            background-color: rgba(88, 166, 255, 0.1);
            border-left: 4px solid #58a6ff;
        }
        .highlight-row {
            background-color: rgba(56, 139, 253, 0.2) !important;
        }
        #positions-table-body td, #events-table-body td {
            color: #f0f6fc;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <div class="row mb-3">
            <div class="col-12">
                <h2><i class="bi bi-graph-up-arrow"></i> Helix Trading Terminal</h2>
                <hr>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Prices and Charts -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-currency-exchange"></i> Market Prices
                    </div>
                    <div class="card-body">
                        <div class="price-box highlight-box">
                            <div class="price-label">BTC/USD</div>
                            <div class="price-value" id="btc-price">$0.00</div>
                        </div>
                        <div class="price-box highlight-box">
                            <div class="price-label">ETH/USD</div>
                            <div class="price-value" id="eth-price">$0.00</div>
                        </div>
                        <div class="price-box">
                            <div class="price-label">BTC/ETH Ratio</div>
                            <div class="price-value" id="btc-eth-ratio">0.0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-activity"></i> Helix Indicator
                    </div>
                    <div class="card-body">
                        <div class="price-box highlight-box">
                            <div class="price-label">Helix 15m</div>
                            <div class="price-value" id="helix-15m">0.0000</div>
                        </div>
                        <div class="helix-gauge" id="helix-15m-gauge">
                            <div class="helix-marker" id="helix-15m-marker" style="left: 50%;"></div>
                            <div class="helix-value" id="helix-15m-value-display" style="left: 50%;">0.0000</div>
                        </div>
                        <div class="price-box">
                            <div class="price-label">Helix 1h</div>
                            <div class="price-value" id="helix-1h">0.0000</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-sliders"></i> Bot Controls
                    </div>
                    <div class="card-body">
                        <button id="pause-bot" class="btn btn-control w-100 mb-2">
                            <i class="bi bi-pause-circle-fill"></i> Pause Trading
                        </button>
                        <button id="resume-bot" class="btn btn-control w-100">
                            <i class="bi bi-play-circle-fill"></i> Resume Trading
                        </button>
                    </div>
                </div>
            </div>

            <!-- Middle Column: Open Positions and Events -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-list-check"></i> Open Positions
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Ticket</th>
                                        <th>Symbol</th>
                                        <th>Type</th>
                                        <th>Volume</th>
                                        <th>Open Price</th>
                                        <th>Current</th>
                                        <th>Profit</th>
                                    </tr>
                                </thead>
                                <tbody id="positions-table-body">
                                    <!-- Positions will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-lightning-charge-fill"></i> Trading Events
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Event ID</th>
                                        <th>Helix Entry</th>
                                        <th>Positions</th>
                                        <th>Current PnL</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="events-table-body">
                                    <!-- Events will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-terminal-fill"></i> Bot Log
                    </div>
                    <div class="card-body">
                        <pre id="terminal-output" class="terminal-output"></pre>
                    </div>
                </div>
            </div>

            <!-- Right Column: Status and Settings -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-info-circle-fill"></i> Bot Status
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-8">
                                <span class="param-label">Trading Status:</span>
                            </div>
                            <div class="col-4 text-end">
                                <span class="param-value" id="trading-status">ACTIVE</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-8">
                                <span class="param-label">Active Events:</span>
                            </div>
                            <div class="col-4 text-end">
                                <span class="param-value" id="active-events">0/10</span>
                            </div>
                        </div>
                        <div class="row mb-2 highlight-box py-2 mb-3">
                            <div class="col-8">
                                <span class="param-label">Total PnL:</span>
                            </div>
                            <div class="col-4 text-end">
                                <span class="param-value" id="total-pnl">$0.00</span>
                            </div>
                        </div>
                        <div class="row mb-2 highlight-box py-2 mb-3">
                            <div class="col-8">
                                <span class="param-label">Booked PnL:</span>
                            </div>
                            <div class="col-4 text-end">
                                <span class="param-value" id="booked-pnl">$0.00</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-8">
                                <span class="param-label">Events Opened:</span>
                            </div>
                            <div class="col-4 text-end">
                                <span class="param-value" id="events-opened">0</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-8">
                                <span class="param-label">Events Closed:</span>
                            </div>
                            <div class="col-4 text-end">
                                <span class="param-value" id="events-closed">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-gear-fill"></i> Trading Parameters
                    </div>
                    <div class="card-body">
                        <form class="settings-form">
                            <div class="mb-3">
                                <label for="btc-qty" class="form-label">BTC Quantity</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="btc-qty" step="0.01" min="0.01">
                                    <button class="btn btn-outline-secondary" type="button" id="set-btc-qty">Set</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="eth-qty" class="form-label">ETH Quantity</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="eth-qty" step="0.01" min="0.01">
                                    <button class="btn btn-outline-secondary" type="button" id="set-eth-qty">Set</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="btc-scale" class="form-label">BTC Scale</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="btc-scale" step="0.1" min="0.1">
                                    <button class="btn btn-outline-secondary" type="button" id="set-btc-scale">Set</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="eth-scale" class="form-label">ETH Scale</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="eth-scale" step="0.1" min="0.1">
                                    <button class="btn btn-outline-secondary" type="button" id="set-eth-scale">Set</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="helix-threshold" class="form-label">Helix Threshold</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="helix-threshold" step="0.01" min="0.01">
                                    <button class="btn btn-outline-secondary" type="button" id="set-helix-threshold">Set</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="helix-step" class="form-label">Helix Step Size</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="helix-step" step="0.01" min="0.01">
                                    <button class="btn btn-outline-secondary" type="button" id="set-helix-step">Set</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="pnl-target" class="form-label">PnL Target Per Event</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="pnl-target" step="0.5" min="0.5">
                                    <button class="btn btn-outline-secondary" type="button" id="set-pnl-target">Set</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        // Connect to WebSocket with reconnection options
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000
        });
        
        // Keep track of last update time
        let lastUpdateTime = Date.now();
        let connectionStatus = 'connecting';
        
        // Terminal output
        const terminal = document.getElementById('terminal-output');
        
        // Add log message to terminal
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            terminal.innerHTML += `[${timestamp}] ${message}\n`;
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        // Format price with commas and 2 decimal places
        function formatPrice(price) {
            return new Intl.NumberFormat('en-US', { 
                style: 'currency', 
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(price);
        }
        
        // Format Helix value with 4 decimal places
        function formatHelix(value) {
            return parseFloat(value).toFixed(4);
        }
        
        // Get profit CSS class
        function getProfitClass(profit) {
            if (profit > 0) return 'positive';
            if (profit < 0) return 'negative';
            return 'neutral';
        }
        
        // Update Helix gauge
        function updateHelixGauge(value) {
            // Convert Helix value (-1 to 1 range) to position (0 to 100%)
            const position = ((parseFloat(value) + 1) / 2) * 100;
            document.getElementById('helix-15m-marker').style.left = `${position}%`;
            document.getElementById('helix-15m-value-display').style.left = `${position}%`;
            document.getElementById('helix-15m-value-display').textContent = formatHelix(value);
        }

        // Update connection status in UI
        function updateConnectionStatus(status) {
            connectionStatus = status;
            const statusIndicator = document.createElement('div');
            statusIndicator.style.position = 'fixed';
            statusIndicator.style.top = '10px';
            statusIndicator.style.right = '10px';
            statusIndicator.style.padding = '5px 10px';
            statusIndicator.style.borderRadius = '4px';
            statusIndicator.style.fontSize = '12px';
            statusIndicator.style.fontWeight = 'bold';
            statusIndicator.style.zIndex = '9999';
            
            if (status === 'connected') {
                statusIndicator.style.backgroundColor = '#238636';
                statusIndicator.textContent = '● Connected';
            } else if (status === 'disconnected') {
                statusIndicator.style.backgroundColor = '#da3633';
                statusIndicator.textContent = '● Disconnected';
            } else if (status === 'connecting') {
                statusIndicator.style.backgroundColor = '#ffbd2e';
                statusIndicator.textContent = '● Connecting...';
            }
            
            // Remove existing status indicator if any
            const existingIndicator = document.getElementById('connection-status');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            statusIndicator.id = 'connection-status';
            document.body.appendChild(statusIndicator);
        }
        
        // Check for updates and reconnect if needed
        function checkForUpdates() {
            const timeSinceLastUpdate = Date.now() - lastUpdateTime;
            
            // If no updates for more than 10 seconds and socket is supposedly connected
            if (timeSinceLastUpdate > 10000 && connectionStatus === 'connected') {
                addLog('No updates received for 10 seconds. Attempting to reconnect...');
                updateConnectionStatus('connecting');
                socket.disconnect().connect();
            }
        }
        
        // Set interval to check for updates every 5 seconds
        setInterval(checkForUpdates, 5000);
        
        // Update position table
        function updatePositionsTable(positions) {
            const tableBody = document.getElementById('positions-table-body');
            tableBody.innerHTML = '';
            
            if (positions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center">No open positions</td>';
                tableBody.appendChild(row);
                return;
            }
            
            positions.forEach((position, index) => {
                const row = document.createElement('tr');
                if (index % 2 === 0) row.classList.add('highlight-row');
                row.innerHTML = `
                    <td>${position.ticket}</td>
                    <td>${position.symbol}</td>
                    <td><span class="badge ${position.type === 'BUY' ? 'badge-bull' : 'badge-bear'}">${position.type}</span></td>
                    <td>${position.volume}</td>
                    <td>${position.open_price}</td>
                    <td>${position.current_price}</td>
                    <td class="${getProfitClass(position.profit)}">${formatPrice(position.profit)}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update the last update time
            lastUpdateTime = Date.now();
        }
        
        // Update events table
        function updateEventsTable(events) {
            const tableBody = document.getElementById('events-table-body');
            tableBody.innerHTML = '';
            
            if (events.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" class="text-center">No active events</td>';
                tableBody.appendChild(row);
                return;
            }
            
            events.forEach((event, index) => {
                const row = document.createElement('tr');
                if (index % 2 === 0) row.classList.add('highlight-row');
                row.innerHTML = `
                    <td>${event.event_id}</td>
                    <td>${formatHelix(event.helix_entry)}</td>
                    <td>${event.positions.join(', ')}</td>
                    <td class="${getProfitClass(event.pnl)}">${formatPrice(event.pnl)}</td>
                    <td><span class="badge badge-bull">ACTIVE</span></td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update the last update time
            lastUpdateTime = Date.now();
        }
        
        // Initialize the page
        window.onload = function() {
            // Set initial connection status
            updateConnectionStatus('connecting');
            
            // Fetch initial status
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update trading parameters
                    document.getElementById('btc-qty').value = data.trading_params.btc_qty;
                    document.getElementById('eth-qty').value = data.trading_params.eth_qty;
                    document.getElementById('btc-scale').value = data.trading_params.btc_scale;
                    document.getElementById('eth-scale').value = data.trading_params.eth_scale;
                    document.getElementById('helix-threshold').value = data.trading_params.helix_threshold;
                    document.getElementById('helix-step').value = data.trading_params.helix_step_size;
                    document.getElementById('pnl-target').value = data.trading_params.pnl_target_per_event;
                    
                    // Update latest values
                    document.getElementById('btc-price').textContent = formatPrice(data.latest_values.btc_price);
                    document.getElementById('eth-price').textContent = formatPrice(data.latest_values.eth_price);
                    document.getElementById('btc-eth-ratio').textContent = data.latest_values.btc_eth_ratio;
                    document.getElementById('helix-15m').textContent = formatHelix(data.latest_values.helix_15m);
                    document.getElementById('helix-1h').textContent = formatHelix(data.latest_values.helix_1h);
                    
                    // Update Helix gauge
                    updateHelixGauge(data.latest_values.helix_15m);
                    
                    addLog('Connected to Helix Trading Bot');
                    
                    // Update the last update time
                    lastUpdateTime = Date.now();
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    addLog('Error connecting to Helix Trading Bot');
                });
            
            // Fetch initial positions
            fetch('/api/positions')
                .then(response => response.json())
                .then(data => {
                    updatePositionsTable(data);
                })
                .catch(error => {
                    console.error('Error fetching positions:', error);
                });
                
            // Add manual refresh button
            const refreshButton = document.createElement('button');
            refreshButton.className = 'btn btn-outline-secondary btn-sm';
            refreshButton.style.position = 'fixed';
            refreshButton.style.bottom = '20px';
            refreshButton.style.right = '20px';
            refreshButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Data';
            refreshButton.addEventListener('click', () => {
                addLog('Manual refresh triggered');
                
                // Refresh positions
                fetch('/api/positions')
                    .then(response => response.json())
                    .then(data => {
                        updatePositionsTable(data);
                        addLog('Positions refreshed');
                    })
                    .catch(error => {
                        console.error('Error fetching positions:', error);
                    });
                    
                // Refresh events
                fetch('/api/events')
                    .then(response => response.json())
                    .then(data => {
                        updateEventsTable(data);
                        addLog('Events refreshed');
                    })
                    .catch(error => {
                        console.error('Error fetching events:', error);
                    });
                    
                // Refresh status
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => {
                        // Update latest values
                        document.getElementById('btc-price').textContent = formatPrice(data.latest_values.btc_price);
                        document.getElementById('eth-price').textContent = formatPrice(data.latest_values.eth_price);
                        document.getElementById('btc-eth-ratio').textContent = data.latest_values.btc_eth_ratio;
                        document.getElementById('helix-15m').textContent = formatHelix(data.latest_values.helix_15m);
                        document.getElementById('helix-1h').textContent = formatHelix(data.latest_values.helix_1h);
                        
                        // Update Helix gauge
                        updateHelixGauge(data.latest_values.helix_15m);
                        
                        addLog('Status refreshed');
                    })
                    .catch(error => {
                        console.error('Error fetching status:', error);
                    });
            });
            document.body.appendChild(refreshButton);
        };
        
        // WebSocket event handlers
        socket.on('connect', () => {
            addLog('WebSocket connection established');
            updateConnectionStatus('connected');
            lastUpdateTime = Date.now();
            
            // Force an immediate refresh of data upon reconnection
            fetch('/api/positions')
                .then(response => response.json())
                .then(data => {
                    updatePositionsTable(data);
                })
                .catch(error => {
                    console.error('Error fetching positions:', error);
                });
                
            fetch('/api/events')
                .then(response => response.json())
                .then(data => {
                    updateEventsTable(data);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                });
        });
        
        socket.on('disconnect', () => {
            addLog('WebSocket connection lost');
            updateConnectionStatus('disconnected');
        });
        
        socket.on('connect_error', (error) => {
            addLog(`Connection error: ${error.message}`);
            updateConnectionStatus('disconnected');
        });
        
        socket.on('connect_timeout', () => {
            addLog('Connection timeout');
            updateConnectionStatus('disconnected');
        });
        
        socket.on('reconnect', (attemptNumber) => {
            addLog(`Reconnected after ${attemptNumber} attempts`);
            updateConnectionStatus('connected');
            lastUpdateTime = Date.now();
        });
        
        socket.on('reconnect_attempt', (attemptNumber) => {
            addLog(`Reconnection attempt ${attemptNumber}`);
            updateConnectionStatus('connecting');
        });
        
        socket.on('reconnect_error', (error) => {
            addLog(`Reconnection error: ${error.message}`);
        });
        
        socket.on('reconnect_failed', () => {
            addLog('Failed to reconnect');
            updateConnectionStatus('disconnected');
        });
        
        socket.on('status_update', (data) => {
            document.getElementById('trading-status').textContent = data.trading_status;
            document.getElementById('trading-status').className = 'param-value ' + (data.trading_status === 'ACTIVE' ? 'positive' : 'negative');
            document.getElementById('active-events').textContent = `${data.active_events}/${data.max_active_events}`;
            document.getElementById('total-pnl').textContent = formatPrice(data.total_pnl);
            document.getElementById('total-pnl').className = 'param-value ' + getProfitClass(data.total_pnl);
            document.getElementById('booked-pnl').textContent = formatPrice(data.booked_pnl);
            document.getElementById('booked-pnl').className = 'param-value ' + getProfitClass(data.booked_pnl);
            document.getElementById('events-opened').textContent = data.events_opened;
            document.getElementById('events-closed').textContent = data.events_closed;
            
            // Update the last update time
            lastUpdateTime = Date.now();
        });
        
        socket.on('price_update', (data) => {
            document.getElementById('btc-price').textContent = formatPrice(data.btc_price);
            document.getElementById('eth-price').textContent = formatPrice(data.eth_price);
            document.getElementById('btc-eth-ratio').textContent = data.btc_eth_ratio;
            document.getElementById('helix-15m').textContent = formatHelix(data.helix_15m);
            document.getElementById('helix-1h').textContent = formatHelix(data.helix_1h);
            
            // Update Helix gauge
            updateHelixGauge(data.helix_15m);
            
            // Update the last update time
            lastUpdateTime = Date.now();
        });
        
        socket.on('position_update', (data) => {
            updatePositionsTable(data);
            // Update the last update time
            lastUpdateTime = Date.now();
        });
        
        socket.on('event_update', (data) => {
            updateEventsTable(data);
            // Update the last update time
            lastUpdateTime = Date.now();
        });
        
        // Button event handlers
        document.getElementById('pause-bot').addEventListener('click', () => {
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: 'pause' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog('Bot paused');
                }
            })
            .catch(error => {
                console.error('Error pausing bot:', error);
                addLog('Error pausing bot');
            });
        });
        
        document.getElementById('resume-bot').addEventListener('click', () => {
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: 'resume' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog('Bot resumed');
                }
            })
            .catch(error => {
                console.error('Error resuming bot:', error);
                addLog('Error resuming bot');
            });
        });
        
        // Set BTC quantity
        document.getElementById('set-btc-qty').addEventListener('click', () => {
            const value = document.getElementById('btc-qty').value;
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: `set btc_qty ${value}` })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`BTC quantity set to ${value}`);
                }
            })
            .catch(error => {
                console.error('Error setting BTC quantity:', error);
                addLog('Error setting BTC quantity');
            });
        });
        
        // Set ETH quantity
        document.getElementById('set-eth-qty').addEventListener('click', () => {
            const value = document.getElementById('eth-qty').value;
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: `set eth_qty ${value}` })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`ETH quantity set to ${value}`);
                }
            })
            .catch(error => {
                console.error('Error setting ETH quantity:', error);
                addLog('Error setting ETH quantity');
            });
        });
        
        // Set BTC scale
        document.getElementById('set-btc-scale').addEventListener('click', () => {
            const value = document.getElementById('btc-scale').value;
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: `set btc_scale ${value}` })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`BTC scale set to ${value}`);
                }
            })
            .catch(error => {
                console.error('Error setting BTC scale:', error);
                addLog('Error setting BTC scale');
            });
        });
        
        // Set ETH scale
        document.getElementById('set-eth-scale').addEventListener('click', () => {
            const value = document.getElementById('eth-scale').value;
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: `set eth_scale ${value}` })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`ETH scale set to ${value}`);
                }
            })
            .catch(error => {
                console.error('Error setting ETH scale:', error);
                addLog('Error setting ETH scale');
            });
        });
        
        // Set Helix threshold
        document.getElementById('set-helix-threshold').addEventListener('click', () => {
            const value = document.getElementById('helix-threshold').value;
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: `set threshold ${value}` })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`Helix threshold set to ${value}`);
                }
            })
            .catch(error => {
                console.error('Error setting Helix threshold:', error);
                addLog('Error setting Helix threshold');
            });
        });
        
        // Set Helix step
        document.getElementById('set-helix-step').addEventListener('click', () => {
            const value = document.getElementById('helix-step').value;
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: `set step ${value}` })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`Helix step size set to ${value}`);
                }
            })
            .catch(error => {
                console.error('Error setting Helix step size:', error);
                addLog('Error setting Helix step size');
            });
        });
        
        // Set PnL target
        document.getElementById('set-pnl-target').addEventListener('click', () => {
            const value = document.getElementById('pnl-target').value;
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: `set pnl_target ${value}` })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`PnL target per event set to $${value}`);
                }
            })
            .catch(error => {
                console.error('Error setting PnL target:', error);
                addLog('Error setting PnL target');
            });
        });
    </script>
</body>
</html>